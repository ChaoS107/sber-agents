---
alwaysApply: true
---

1. **Общие принципы**

- Пиши код по принципам **KISS** и **YAGNI**: только то, что нужно для текущего MVP, без абстракций «на будущее».
- Отдавай приоритет **читаемости** над «красотой» и «универсальностью».
- Любое усложнение должно быть обосновано конкретной необходимостью (новым реальным сценарием).

2. **Структура и размещение кода**

- Весь прикладной код — в пакете `src/`.
- Основная логика бота (Telegram-хендлеры, работа с контекстом, вызов LLM, базовое логирование и обработка ошибок) — в `bot.py`.
- В `config.py` размещай только логику чтения переменных окружения и экспорт простых констант/настроек.
- В `llm.py` держи только то, что связано с обращением к LLM: системный промпт, подготовка сообщений, параметры модели, вызов клиента.
- Не создавай новые модули и подпакеты без явной необходимости (новый модуль — только если код в существующих файлах становится действительно трудно поддерживаемым).

3. **Зависимости и окружение**

- Используй только согласованные инструменты: Python 3.11, `uv`, `aiogram`, `openai`, `make`.
- Не добавляй новые внешние библиотеки, если задачу можно решить стандартной библиотекой без чрезмерных усилий.
- Конфигурация (токены, ключи, URL, имена моделей, уровни логирования) — только через переменные окружения, читаемые в `config.py`.

4. **Работа с LLM**

- Все обращения к LLM должны проходить через единый слой в `llm.py`.
- Не дублируй системный промпт и параметры LLM в разных местах — используй общие константы.
- Строго ограничивай размер контекста диалога (обрезай список сообщений), не вводи сложный учёт токенов на MVP.

5. **Контекст и состояние**

- Храни контекст диалога только в оперативной памяти процесса (in-memory структуры в `bot.py`).
- Не добавляй постоянное хранение (БД, файлы, кеши) до тех пор, пока это не станет критично для проверки гипотезы.
- Структуры данных должны быть простыми: словари и списки с очевидными полями.

6. **Конфигурация**

- Все чувствительные данные и параметры окружения должны поступать из `.env` / переменных окружения.
- В `config.py` проверяй наличие критичных переменных и падай с понятной ошибкой, если чего-то не хватает.
- Не шей значения, зависящие от среды, прямо в код.

7. **Логирование и отладка**

- Используй только стандартный модуль `logging`, базовая настройка — в `bot.py`.
- Логируй ключевые события: запуск бота, входящие сообщения, вызовы LLM, ошибки.
- Не логируй токены, ключи и другую чувствительную информацию.
- Не добавляй сложную лог-инфраструктуру (отдельные файлы, ротация, внешние сервисы) на этапе MVP.

8. **Обработка ошибок**

- Любые сетевые вызовы (LLM, Telegram) должны быть обёрнуты в `try/except` с логированием ошибок.
- Пользователь должен получать короткое, нейтральное сообщение об ошибке; детали ошибок оставляй только в логах.
- Не пытайся реализовывать сложные механизмы ретраев и fallback’ов на MVP — только простая и надёжная обработка.


